% Function to run the evaluation for a set of parameters without fitting
function [params,loglik_train] = stochastic_eval(direc, out_path)

% Load all the groups
files = dir(direc);
group = cell(length(files)-2, 1);
parfor i=3:length(files)
	group{i-2}=load_data_mat(fullfile(direc,files(i).name));
end	

data = cat(1, group{:});

% Hard code the parameters and evaluate
all_params = [6.952685,0.001015,0.472762,0.001019,0.600464,0.212484,0.192997,0.963584,0.049244,1.299271,0.000014,3.366392,57.861308;
              9.995256,0.001000,0.492637,0.001047,0.570723,0.025340,0.475614,0.000078,0.038610,1.008294,0.384086,5.121231,0.090367;
              10.000000,0.001000,0.393033,0.001061,0.581549,0.420047,0.048042,0.617423,0.051993,0.992682,0.630640,3.292041,4.436638;
              9.923391,0.001000,0.500001,0.001336,0.591559,0.455235,0.059527,0.961974,0.743430,1.225143,0.809742,4.644492,46.342585;
              9.690992,0.001028,0.476637,0.001132,0.721125,0.598577,0.110364,1.118977,0.355344,0.841767,0.350773,4.657892,6.958937;
              9.992933,0.001008,0.379584,0.001001,0.613625,0.408531,0.001362,1.161341,0.658704,0.883919,0.744813,2.890203,5.061198;
              9.995228,0.001004,0.558299,0.001665,0.654087,0.000035,0.004569,0.331168,0.009225,1.701308,1.151033,7.397560,69.644873;
              9.927344,0.001143,0.470507,0.001009,0.626822,0.000717,0.000000,0.000000,1.037998,0.961296,0.580378,4.891885,0.317444;
              7.953740,0.001005,0.483002,0.001008,0.542480,0.009765,0.257062,0.679856,0.244784,1.111234,0.888857,2.841865,19.157763;
              9.915107,0.001007,0.492605,0.001026,0.551522,0.020730,0.081096,0.546811,0.004016,1.266016,0.841700,3.562272,9.381454;
              9.999175,0.001022,0.536247,0.001000,0.541104,0.012831,0.028712,1.224062,0.078224,1.206697,0.912732,5.215931,24.822597;
              9.594795,0.001050,0.444055,0.001004,0.600583,0.000007,0.377500,0.568725,0.291797,0.817968,0.383212,4.823318,0.820534;
              6.596836,0.001202,0.459551,0.002358,0.619694,0.014926,0.002595,1.510762,0.000010,1.193611,0.819354,1.757990,54.220839];
num_evals = size(all_params,1);

for j=1:num_evals

    params = all_params(j,:);
    params
    
    c=1;
    Ntrials=100000;
    fun=@(x) mean(estimate_loglik_ibs_stochastic_sem(data,x,c,Ntrials));
    for i=1:10
	    loglik(i) = fun(params);
    end
    
    loglik_train = [loglik mean(loglik)];
    
    % Save outputs to csv
    param_path = sprintf('%s_params%d.csv', out_path, j);
    lltrain_path = sprintf('%s_lltrain%d.csv', out_path, j);
    
    csvwrite(param_path,params);
    csvwrite(lltrain_path,loglik_train);
end

end